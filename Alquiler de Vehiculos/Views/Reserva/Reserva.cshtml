@{
    ViewData["Title"] = "Reserva";
}

<h1>Reservas</h1>

<div class="card text-center mb-4">
    <div class="card-header">
        <ul class="nav nav-tabs card-header-tabs" id="reservaTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active"
                        id="reservar-tab"
                        data-bs-toggle="tab"
                        data-bs-target="#reservar"
                        type="button"
                        role="tab"
                        aria-controls="reservar"
                        aria-selected="true">
                    <i class="fas fa-calendar-plus me-2"></i>
                    Reservar
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link "
                        id="misreservas-tab"
                        data-bs-toggle="tab"
                        data-bs-target="#misreservas"
                        type="button"
                        role="tab"
                        aria-controls="misreservas"
                        aria-selected="false">
                    <i class="fas fa-list-alt me-2"></i>
                    Mis Reservaciones
                </button>
            </li>
        </ul>
    </div>
    <div class="card-body">
        <div class="tab-content" id="reservaTabsContent">
            <!-- Pestaña de Reservar -->
            <div class="tab-pane fade show active" id="reservar" role="tabpanel" aria-labelledby="reservar-tab">
                <!--Contenedor principal-->
                <div class="container">
                    <!--Sección de selección de vehículo-->
                    <div class="card shadow-lg border-0 rounded-lg mb-4">
                        <div class="card-header bg-gradient text-white" style="background-color:#FAB12F;">
                            <h4 class="mb-0">
                                <i class="fas fa-car me-2"></i>
                                Selección de Vehículo
                            </h4>
                        </div>
                        <div class="card-body">
                            
<!-- Campo para selección por ID -->
<div class="row mb-4">
    <div class="col-md-9">
        <div class="form-floating">
            <input type="number" class="form-control" id="inputVehiculoId" min="1" placeholder="ID del vehículo">
            <label for="inputVehiculoId"><i class="fas fa-hashtag me-2"></i>Ingrese el número de registro del vehículo</label>
        </div>
    </div>
    <div class="col-md-3">
        <button type="button" id="btnSeleccionarVehiculo" class="btn btn-warning h-100 w-100">
            <i class="fas fa-check-circle me-2"></i>Seleccionar
        </button>
    </div>
</div>
                            
                            <!-- Mostrar información del vehículo seleccionado -->
                            <div id="infoVehiculo" class="card p-3 mb-4 d-none">
                                <div class="row">
                                    <div class="col-md-4">
                                        <img id="imagenVehiculo" src="/img/car-placeholder.png" alt="Imagen del vehículo" class="img-fluid rounded">
                                    </div>
                                    <div class="col-md-8">
                                        <h5 id="marcaModeloVehiculo">Marca y Modelo</h5>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <p><strong><i class="fas fa-calendar-alt me-2"></i>Año:</strong> <span id="añoVehiculo">-</span></p>
                                                <p><strong><i class="fas fa-tachometer-alt me-2"></i>Kilometraje:</strong> <span id="kilometrajeVehiculo">-</span> km</p>
                                            </div>
                                            <div class="col-md-6">
                                                <p><strong><i class="fas fa-gas-pump me-2"></i>Combustible:</strong> <span id="combustibleVehiculo">-</span></p>
                                                <p><strong><i class="fas fa-cogs me-2"></i>Transmisión:</strong> <span id="transmisionVehiculo">-</span></p>
                                            </div>
                                        </div>
                                        <div class="alert alert-success">
                                            <strong>Precio por día:</strong> $<span id="precioVehiculoDia">0.00</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Título para la tabla -->
                            <h5 class="mb-3">
                                <i class="fas fa-list me-2"></i>
                                Vehículos disponibles
                            </h5>
                            
                            <!-- Contenedor para la tabla -->
                            <div id="divtabla" class="table-responsive"></div>
                        </div>
                    </div>

                    <!--Sección de fechas-->
                    <div class="card shadow-lg border-0 rounded-lg mb-4">
                        <div class="card-header bg-gradient text-white" style="background-color: #FA812F;">
                            <h4 class="mb-0">
                                <i class="fas fa-calendar-check me-2"></i>
                                Selecciona las Fechas de tu Reserva
                            </h4>
                        </div>
                        <div class="card-body p-4">
                            <form id="fechasReservaForm">
                                <div class="row g-4">
                                    <div class="col-md-6">
                                        <div class="form-floating">
                                            <input type="date"
                                                   class="form-control form-control-lg"
                                                   id="fechaInicio"
                                                   name="fechaInicio"
                                                   required>
                                            <label for="fechaInicio">
                                                <i class="fas fa-calendar-alt text-primary me-2"></i>
                                                Fecha de Inicio
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-floating">
                                            <input type="date"
                                                   class="form-control form-control-lg"
                                                   id="fechaFin"
                                                   name="fechaFin"
                                                   required>
                                            <label for="fechaFin">
                                                <i class="fas fa-calendar-check text-primary me-2"></i>
                                                Fecha de Devolución
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <div class="d-flex justify-content-between align-items-center mt-4">
                                            <span class="text-muted">
                                                <i class="fas fa-info-circle me-2"></i>
                                                Selecciona las fechas para calcular el precio total
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!--Sección de seguros-->
                    <div class="card shadow-lg border-0 rounded-lg mb-4">
                        <div class="card-header bg-gradient text-white" style="background-color: #2F80ED;">
                            <h4 class="mb-0">
                                <i class="fas fa-shield-alt me-2"></i>
                                Seleccione su Seguro
                            </h4>
                        </div>
                        <div class="card-body p-4">
                            <div class="row g-4">
                                <!-- Seguro de Responsabilidad Civil -->
                                <div class="col-md-6 col-lg-4">
                                    <div class="card h-100 insurance-card">
                                        <div class="card-body">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="seguroTipo"
                                                       id="responsabilidadCivil" value="responsabilidadCivil">
                                                <label class="form-check-label w-100" for="responsabilidadCivil">
                                                    <h5 class="mb-3">
                                                        <i class="fas fa-car-crash text-primary me-2"></i>
                                                        Responsabilidad Civil
                                                    </h5>
                                                    <p class="text-muted">Cubre daños a terceros en caso de accidente.</p>
                                                    <div class="price-tag">
                                                        <span class="amount">$80</span>
                                                        <span class="period">/día</span>
                                                    </div>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Cobertura Contra Todo Riesgo -->
                                <div class="col-md-6 col-lg-4">
                                    <div class="card h-100 insurance-card">
                                        <div class="card-body">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="seguroTipo"
                                                       id="todoRiesgo" value="todoRiesgo">
                                                <label class="form-check-label w-100" for="todoRiesgo">
                                                    <h5 class="mb-3">
                                                        <i class="fas fa-car-burst text-danger me-2"></i>
                                                        Todo Riesgo
                                                    </h5>
                                                    <p class="text-muted">Protección completa para cualquier tipo de daño.</p>
                                                    <div class="price-tag">
                                                        <span class="amount">$100</span>
                                                        <span class="period">/día</span>
                                                    </div>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Protección contra Robo -->
                                <div class="col-md-6 col-lg-4">
                                    <div class="card h-100 insurance-card">
                                        <div class="card-body">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="seguroTipo"
                                                       id="proteccionRobo" value="proteccionRobo">
                                                <label class="form-check-label w-100" for="proteccionRobo">
                                                    <h5 class="mb-3">
                                                        <i class="fas fa-shield-halved text-success me-2"></i>
                                                        Protección contra Robo
                                                    </h5>
                                                    <p class="text-muted">Cobertura en caso de robo del vehículo.</p>
                                                    <div class="price-tag">
                                                        <span class="amount">$85</span>
                                                        <span class="period">/día</span>
                                                    </div>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Asistencia en Carretera -->
                                <div class="col-md-6 col-lg-4">
                                    <div class="card h-100 insurance-card">
                                        <div class="card-body">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="seguroTipo"
                                                       id="asistenciaCarretera" value="asistenciaCarretera">
                                                <label class="form-check-label w-100" for="asistenciaCarretera">
                                                    <h5 class="mb-3">
                                                        <i class="fas fa-road text-warning me-2"></i>
                                                        Asistencia en Carretera
                                                    </h5>
                                                    <p class="text-muted">Ayuda 24/7 en caso de emergencias en ruta.</p>
                                                    <div class="price-tag">
                                                        <span class="amount">$90</span>
                                                        <span class="period">/día</span>
                                                    </div>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Seguro de Accidentes Personales -->
                                <div class="col-md-6 col-lg-4">
                                    <div class="card h-100 insurance-card">
                                        <div class="card-body">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="seguroTipo"
                                                       id="accidentesPersonales" value="accidentesPersonales">
                                                <label class="form-check-label w-100" for="accidentesPersonales">
                                                    <h5 class="mb-3">
                                                        <i class="fas fa-user-shield text-info me-2"></i>
                                                        Accidentes Personales
                                                    </h5>
                                                    <p class="text-muted">Protección para conductor y pasajeros.</p>
                                                    <div class="price-tag">
                                                        <span class="amount">$95</span>
                                                        <span class="period">/día</span>
                                                    </div>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Resumen de costos -->
                    <div class="card mb-4 border-0 bg-light">
                        <div class="card-body">
                            <h5 class="mb-4"><i class="fas fa-receipt me-2"></i>Resumen de la Reserva</h5>
                            <div class="table-responsive">
                                <table class="table">
                                    <tbody>
                                        <tr>
                                            <td>Precio por día del vehículo</td>
                                            <td class="text-end">$<span id="costoVehiculo">0.00</span>/día</td>
                                        </tr>
                                        <tr>
                                            <td>Días de alquiler</td>
                                            <td class="text-end"><span id="diasAlquiler">0</span> días</td>
                                        </tr>
                                        <tr>
                                            <td>Seguro seleccionado</td>
                                            <td class="text-end">$<span id="costoSeguro">0.00</span>/día</td>
                                        </tr>
                                        <tr>
                                            <td>Subtotal</td>
                                            <td class="text-end">$<span id="subtotal">0.00</span></td>
                                        </tr>
                                        <tr>
                                            <td>IVA (12%)</td>
                                            <td class="text-end">$<span id="iva">0.00</span></td>
                                        </tr>
                                        <tr class="fw-bold">
                                            <td>Total a Pagar</td>
                                            <td class="text-end">$<span id="totalPagar">0.00</span></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!--Sección de método de pago-->
                    <div class="card shadow-lg border-0 rounded-lg mb-4">
                        <div class="card-header bg-gradient text-white" style="background-color:#28a745;">
                            <h4 class="mb-0">
                                <i class="fas fa-money-check-alt me-2"></i>
                                Seleccione el Método de Pago
                            </h4>
                        </div>
                        <div class="card-body p-4">
                            <div class="row mb-4">
                                <div class="col-12">
                                    <div class="btn-group w-100" role="group">
                                        <input type="radio" class="btn-check" name="metodoPago" id="efectivo" autocomplete="off" checked>
                                        <label class="btn btn-outline-primary" for="efectivo">
                                            <i class="fas fa-money-bill-wave me-2"></i>
                                            Efectivo
                                        </label>

                                        <input type="radio" class="btn-check" name="metodoPago" id="transferencia" autocomplete="off">
                                        <label class="btn btn-outline-primary" for="transferencia">
                                            <i class="fas fa-university me-2"></i>
                                            Transferencia
                                        </label>

                                        <input type="radio" class="btn-check" name="metodoPago" id="tarjeta" autocomplete="off">
                                        <label class="btn btn-outline-primary" for="tarjeta">
                                            <i class="fas fa-credit-card me-2"></i>
                                            Tarjeta
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- Opción Efectivo -->
                            <div id="efectivoContent" class="payment-content">
                                <div class="alert alert-info" role="alert">
                                    <h5 class="alert-heading">
                                        <i class="fas fa-info-circle me-2"></i>
                                        Pago en Efectivo
                                    </h5>
                                    <hr>
                                    <p class="mb-0">Número de Orden: <strong id="ordenNumber"></strong></p>
                                    <p>Presente este número en nuestra agencia para realizar el pago.</p>
                                    <p class="mb-0">La reserva será confirmada una vez se realice el pago.</p>
                                </div>
                            </div>

                            <!-- Opción Transferencia -->
                            <div id="transferenciaContent" class="payment-content d-none">
                                <div class="row g-4">
                                    <div class="col-md-4">
                                        <div class="card h-100 border-primary">
                                            <div class="card-header">
                                                <h5 class="mb-0">Banco Pichincha</h5>
                                            </div>
                                            <div class="card-body">
                                                <p class="card-text">
                                                    <strong>Cuenta Corriente:</strong><br>
                                                    2203456789<br>
                                                    <strong>Titular:</strong><br>
                                                    Car Express S.A.<br>
                                                    <strong>RUC:</strong><br>
                                                    1234567890001
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card h-100 border-success">
                                            <div class="card-header">
                                                <h5 class="mb-0">Banco Guayaquil</h5>
                                            </div>
                                            <div class="card-body">
                                                <p class="card-text">
                                                    <strong>Cuenta Ahorros:</strong><br>
                                                    4567890123<br>
                                                    <strong>Titular:</strong><br>
                                                    Car Express S.A.<br>
                                                    <strong>RUC:</strong><br>
                                                    1234567890001
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card h-100 border-info">
                                            <div class="card-header">
                                                <h5 class="mb-0">Banco Produbanco</h5>
                                            </div>
                                            <div class="card-body">
                                                <p class="card-text">
                                                    <strong>Cuenta Corriente:</strong><br>
                                                    7890123456<br>
                                                    <strong>Titular:</strong><br>
                                                    Car Express S.A.<br>
                                                    <strong>RUC:</strong><br>
                                                    1234567890001
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="alert alert-warning mt-4" role="alert">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    Una vez realizada la transferencia, por favor enviar el comprobante al correo: pagos@carexpress.com
                                </div>
                            </div>

                            <!-- Opción Tarjeta -->
                            <div id="tarjetaContent" class="payment-content d-none">
                                <!-- Aquí va el formulario de tarjeta existente -->
                                <form class="row g-3 needs-validation" novalidate>
                                    <div class="col-md-6">
                                        <div class="form-floating mb-3">
                                            <input type="text" class="form-control" id="nombreTarjeta" required
                                                   placeholder="Nombre en la tarjeta">
                                            <label for="nombreTarjeta">
                                                <i class="fas fa-user me-2"></i>
                                                Nombre en la tarjeta
                                            </label>
                                            <div class="invalid-feedback">
                                                Por favor ingrese el nombre que aparece en la tarjeta.
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                        <div class="form-floating mb-3">
                                            <input type="text" class="form-control" id="numeroTarjeta" required
                                                   placeholder="Número de tarjeta">
                                            <label for="numeroTarjeta">
                                                <i class="fas fa-credit-card me-2"></i>
                                                Número de tarjeta
                                            </label>
                                            <div class="invalid-feedback">
                                                Por favor ingrese un número de tarjeta válido (16 dígitos).
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-4">
                                        <div class="form-floating mb-3">
                                            <input type="text" class="form-control" id="fechaExpiracion" required
                                                   placeholder="MM/YY">
                                            <label for="fechaExpiracion">
                                                <i class="fas fa-calendar-alt me-2"></i>
                                                Fecha de expiración (MM/YY)
                                            </label>
                                            <div class="invalid-feedback">
                                                Por favor ingrese una fecha válida (MM/YY).
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-4">
                                        <div class="form-floating mb-3">
                                            <input type="text" class="form-control" id="cvv" required
                                                   placeholder="CVV">
                                            <label for="cvv">
                                                <i class="fas fa-lock me-2"></i>
                                                CVV
                                            </label>
                                            <div class="invalid-feedback">
                                                Por favor ingrese un CVV válido.
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-4">
                                        <div class="form-floating mb-3">
                                            <select class="form-select" id="tipoTarjeta" required>
                                                <option value="" disabled selected>Seleccione...</option>
                                                <option value="visa">Visa</option>
                                                <option value="mastercard">Mastercard</option>
                                                <option value="amex">American Express</option>
                                            </select>
                                            <label for="tipoTarjeta">
                                                <i class="fas fa-credit-card me-2"></i>
                                                Tipo de tarjeta
                                            </label>
                                            <div class="invalid-feedback">
                                                Por favor seleccione un tipo de tarjeta.
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-12">
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" id="terminos" required>
                                            <label class="form-check-label" for="terminos">
                                                Acepto los términos y condiciones del servicio
                                            </label>
                                            <div class="invalid-feedback">
                                                Debe aceptar los términos y condiciones para continuar.
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!--Botón de confirmación final-->
                    <div class="d-grid gap-2 col-6 mx-auto mb-4">
                        <button class="btn btn-success btn-lg" type="button" id="btnConfirmarReserva">
                            <i class="fas fa-check-circle me-2"></i>
                            Confirmar Reserva
                        </button>
                    </div>
                </div>
            </div>

            <!-- Pestaña de Mis Reservaciones -->
            <div class="tab-pane fade" id="misreservas" role="tabpanel" aria-labelledby="misreservas-tab">
                <div class="container">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Nº Reserva</th>
                                    <th>Vehículo</th>
                                    <th>Fecha Inicio</th>
                                    <th>Fecha Fin</th>
                                    <th>Estado</th>
                                    <th>Total</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tbodyMisReservas">
                                <!-- Aquí se cargarán dinámicamente las reservas del usuario -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Validación del formulario
        (function () {
            'use strict'
            var forms = document.querySelectorAll('.needs-validation')
            Array.prototype.slice.call(forms)
                .forEach(function (form) {
                    form.addEventListener('submit', function (event) {
                        if (!form.checkValidity()) {
                            event.preventDefault()
                            event.stopPropagation()
                        }
                        form.classList.add('was-validated')
                    }, false)
                })
        })()
        
        // Función para cargar reservas del usuario
        function cargarMisReservas() {
            const usuarioId = localStorage.getItem('usuarioId');
            if (!usuarioId) {
                // Si no hay usuario logueado, mostrar mensaje
                document.getElementById('tbodyMisReservas').innerHTML = 
                    '<tr><td colspan="7" class="text-center">Debe iniciar sesión para ver sus reservas</td></tr>';
                return;
            }
            
            fetchGet(`Reserva/ReservasPorCliente?clienteId=${usuarioId}`, "json", function(data) {
                if (!data || !Array.isArray(data)) {
                    document.getElementById('tbodyMisReservas').innerHTML = 
                        '<tr><td colspan="7" class="text-center">No se pudieron cargar las reservas</td></tr>';
                    return;
                }
                
                if (data.length === 0) {
                    document.getElementById('tbodyMisReservas').innerHTML = 
                        '<tr><td colspan="7" class="text-center">No tiene reservas activas</td></tr>';
                    return;
                }
                
                let html = '';
                data.forEach(reserva => {
                    const fechaInicio = new Date(reserva.fechaInicio).toLocaleDateString();
                    const fechaFin = new Date(reserva.fechaFin).toLocaleDateString();
                    
                    let estadoClass = "";
                    switch (reserva.estado.toLowerCase()) {
                        case 'pendiente':
                            estadoClass = "bg-warning";
                            break;
                        case 'confirmada':
                            estadoClass = "bg-success";
                            break;
                        case 'cancelada':
                            estadoClass = "bg-danger";
                            break;
                        default:
                            estadoClass = "bg-secondary";
                    }
                    
                    html += `
                        <tr>
                            <td>${reserva.numeroReserva}</td>
                            <td>${reserva.vehiculo}</td>
                            <td>${fechaInicio}</td>
                            <td>${fechaFin}</td>
                            <td><span class="badge ${estadoClass}">${reserva.estado}</span></td>
                            <td>$${reserva.total}</td>
                            <td>
                                ${reserva.estado.toLowerCase() === 'pendiente' ? `
                                    <button class="btn btn-sm btn-warning" title="Editar">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger" title="Eliminar">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                ` : ''}
                            </td>
                        </tr>
                    `;
                });
                
                document.getElementById('tbodyMisReservas').innerHTML = html;
            });
        }
        
        // Llamar a la función para cargar las reservas al cargar la página
        document.addEventListener('DOMContentLoaded', cargarMisReservas);
    </script>
}

@section Styles {
    <link rel="stylesheet" href="~/css/reserva.css" />
}
<script src="~/js/reserva.js"></script>
<script src="~/js/generic.js"></script>
<script src="~/js/vehiculo.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>
